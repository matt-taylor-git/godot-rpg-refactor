<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>1</storyId>
    <title>Main Menu Modernization</title>
    <status>drafted</status>
    <generatedAt>2025-11-25</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/3-1-main-menu-modernization.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>player at the main menu</asA>
    <iWant>a polished, welcoming interface</iWant>
    <soThat>I feel excited to start playing and can easily navigate to the game functions</soThat>
    <tasks>
- [ ] **Task 1: Update Main Menu Scene Layout** (AC: AC-3.1.1)
  - [ ] Open `scenes/ui/main_menu.tscn`
  - [ ] Apply `ui_theme.tres` to the root control
  - [ ] restructure layout using VBoxContainer/CenterContainer for 8px grid alignment
  - [ ] Add Game Title with header typography style
  - [ ] Ensure background image covers full screen (16:9)

- [ ] **Task 2: Integrate UIButton Component** (AC: AC-3.1.2)
  - [ ] Replace standard Buttons with `scenes/components/ui_button.tscn` instances
  - [ ] Configure labels: "New Game", "Load Game", "Options", "Quit"
  - [ ] Connect pressed signals to script methods
  - [ ] Verify hover/focus states work via UIButton logic

- [ ] **Task 3: Implement MainMenu Controller Logic** (AC: AC-3.1.2)
  - [ ] Update `scripts/ui/MainMenu.gd` to extend `BaseUI`
  - [ ] Implement signal handlers for buttons
  - [ ] Connect "New Game" to `GameManager.start_new_game()` (or scene change)
  - [ ] Connect "Quit" to `get_tree().quit()`

- [ ] **Task 4: Implement Visual Polish & Atmosphere** (AC: AC-3.1.3, AC-3.1.4)
  - [ ] Add `GPUParticles2D` or `TextureRect` with shader for background atmosphere
  - [ ] Create `_animate_background()` method
  - [ ] Implement `respect_reduced_motion` check to disable animations
  - [ ] Add `_transition_in()` and `_transition_out()` methods using Tweens (fade/slide)

- [ ] **Task 5: Accessibility & Input Handling** (AC: AC-3.1.4)
  - [ ] Setup focus neighbors for keyboard navigation (Up/Down arrows)
  - [ ] Set default focus on "New Game" button on start
  - [ ] Verify contrast ratios (using theme colors)

- [ ] **Task 6: Testing** (AC: All)
  - [ ] Create `tests/godot/test_main_menu.gd`
  - [ ] Test button connections and signal emissions
  - [ ] Test navigation focus logic
  - [ ] Test reduced motion toggle effect on background
</tasks>
  </story>

  <acceptanceCriteria>
1. **AC-3.1.1: Modern Layout & Styling** - Given the game is launched, when the main menu appears, then the layout uses a centered design with proper spacing (following 8px grid), consistent typography (headers, body) defined in `ui_theme.tres`, and a cohesive color scheme.
2. **AC-3.1.2: Interactive Elements** - Given the menu has options (New Game, Load, Options, Quit), when I interact with them, then they use the standardized `UIButton` component with distinct normal, hover, pressed, and disabled states, including sound effects and visual feedback.
3. **AC-3.1.3: Visual Polish & Atmosphere** - Given the menu is idle, then the background displays subtle animations (e.g., particle effects or scrolling parallax) to create atmosphere; When the menu opens or closes, smooth fade/slide transitions occur (approx 500ms).
4. **AC-3.1.4: Responsiveness & Accessibility** - Given I use different input methods, then the menu supports full keyboard navigation with clear focus indicators, supports 16:9 aspect ratio scaling, and all text meets the 4.5:1 contrast ratio standard. "Reduced Motion" setting disables background animations.
</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 3: Menu System Redesign</section>
        <snippet>Goal: Modernize all game menus with intuitive navigation and professional presentation. Story 3.1 focuses on Main Menu Modernization with polished layout and transitions.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Implementation Patterns</section>
        <snippet>UI Component Creation Pattern: Extend Control/BaseUI, use @onready, use ui_theme.tres. Animation Pattern: Use Tween nodes, always kill tweens on cleanup.</snippet>
      </doc>
      <doc>
        <path>docs/stories/1-1-modern-button-component-system.md</path>
        <title>Story 1.1: Modern Button System</title>
        <section>Acceptance Criteria</section>
        <snippet>Defines UIButton behavior: hover/pressed states, animations, focus indicators. This component should be reused in the Main Menu.</snippet>
      </doc>
      <doc>
        <path>docs/stories/2-3-character-portrait-enhancement.md</path>
        <title>Story 2.3: Character Portrait Enhancement</title>
        <section>Learnings from Previous Story</section>
        <snippet>Critical learnings: Always kill tweens, support reduced motion settings, use ui_theme.tres for consistency.</snippet>
      </doc>
    </docs>
    <code>
      <item>
        <path>scripts/ui/MainMenu.gd</path>
        <kind>controller</kind>
        <symbol>MainMenu</symbol>
        <reason>The main controller script to be modernized. Currently basic, needs to extend BaseUI and handle new polish.</reason>
      </item>
      <item>
        <path>scenes/ui/main_menu.tscn</path>
        <kind>scene</kind>
        <symbol>main_menu</symbol>
        <reason>The scene file defining the visual layout. Needs update to use VBoxContainer, correct anchoring, and UIButton instances.</reason>
      </item>
      <item>
        <path>scripts/ui/BaseUI.gd</path>
        <kind>class</kind>
        <symbol>BaseUI</symbol>
        <reason>Base class for all UI screens. MainMenu must inherit from this to share common UI functionality.</reason>
      </item>
      <item>
        <path>scripts/components/UIButton.gd</path>
        <kind>component</kind>
        <symbol>UIButton</symbol>
        <reason>Reusable button component created in Epic 1. Must be used for all menu buttons.</reason>
      </item>
      <item>
        <path>resources/ui_theme.tres</path>
        <kind>resource</kind>
        <symbol>Theme</symbol>
        <reason>Central theme resource containing fonts, colors, and styles. Must be applied to the menu root.</reason>
      </item>
    </code>
    <dependencies>
      <item>godot-4.5</item>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Must inherit from BaseUI.gd (scripts/ui/BaseUI.gd)</constraint>
    <constraint>Must use resources/ui_theme.tres for all styling</constraint>
    <constraint>Must reuse UIButton component (scenes/components/ui_button.tscn)</constraint>
    <constraint>Animations must respect 'reduced_motion' setting</constraint>
    <constraint>Must clean up Tweens using tween.kill() or bound cleanup</constraint>
    <constraint>Must maintain 16:9 aspect ratio compatibility</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GameManager.start_new_game</name>
      <kind>function</kind>
      <signature>start_new_game(player_name, class_name)</signature>
      <path>scripts/globals/GameManager.gd</path>
    </interface>
    <interface>
      <name>BaseUI.show/hide</name>
      <kind>function</kind>
      <signature>show(), hide()</signature>
      <path>scripts/ui/BaseUI.gd</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Use GUT framework. Create tests in tests/godot/. Verify signal emissions, focus navigation, and state changes. Mock GameManager if necessary.</standards>
    <locations>tests/godot/</locations>
    <ideas>
      <idea>Test that clicking 'New Game' calls GameManager.start_new_game</idea>
      <idea>Test that keyboard focus starts on 'New Game' button</idea>
      <idea>Test that background animation is disabled when reduced_motion is true</idea>
      <idea>Test that pressing 'Quit' calls get_tree().quit() (mocked)</idea>
    </ideas>
  </tests>
</story-context>
